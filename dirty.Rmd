```{r}
# Loading lib 
library(tidyverse)
library(readxl)

```

```{r}
## function to load and transform data
get_data <- function(path) {
  # get dates from xls
  dates <- read_excel(path = path, sheet = "TYGODNIE ISO8601") %>%
    mutate(TYDZIEŃ = str_extract(TYDZIEŃ, "T[0-9]{2}")) %>%
    rename(week = TYDZIEŃ) %>%
    mutate(DATA = lubridate::floor_date(DATA, "weeks", week_start = 1)) %>%
    distinct()
  # load and transform data
  df <-
    read_excel(path = path, sheet = 1, skip = 6) %>%
    rename(
      "age_group" = "...1",
      "code" = "...2",
      "name" = "...3"
    ) %>%
    slice(-(1:3)) %>%
    filter(
      age_group != "Ogółem",
      str_length(code) == 4
    ) %>%
    select(-code) %>%
    pivot_longer(cols = contains("T"), names_to = "week_no", values_to = "num_deaths") %>%
    left_join(dates, by = c("week_no" = "week")) %>%
    mutate(year_date = str_extract(path, "[0-9]{4}"))
}


# loading data 

df_full <-
  map(list.files("data/zgony_wedlug_tygodni 2/", full.names = T), get_data)

```

```{r}
df_r <- map_dfr(df_full,rbind) %>% 
  filter(year_date %in% c(2015,2016,2017,2018,2019,2020)) 
```

```{r}
 df_r%>% 
  group_by(year_date) %>% 
  summarise(total_d = sum(num_deaths)) %>% 
  ggplot(aes(year_date,total_d)) +
  geom_col()+
  scale_y_continuous(labels = scales::label_number())
```
```{r}
df_r %>% 
  #filter(age_group == "80 - 84") %>% 
  group_by(DATA,year_date,name) %>%
  summarise(total_d =sum(num_deaths)) %>% 
  ggplot(aes(DATA,total_d,color = year_date))+
  geom_line()+
  facet_wrap(~name)
```
```{r}
df_r %>% 
  group_by(name,week_no,year_date) %>% 
  summarise(total_deaths = sum(num_deaths)) %>% 
  unite(col = "week_year",c(week_no,year_date),sep = "_") %>% 
  group_by(week_year,name) %>% 
  summarise(weekly_total = sum(total_deaths)) %>% 
   separate(week_year,into = c("week","year"),remove = T) %>% 
  # select(-week,-year) %>% 
  pivot_wider(names_from = year,values_from = weekly_total) %>% 
 mutate(diff2020_2019 = (`2020`-`2019`)/`2019`) %>% 
  ggplot(aes(week,diff2020_2019,group = 1,fill = if_else(diff2020_2019 >0,"green","red")))+
  geom_col(show.legend = F)+
  #geom_abline(intercept = 0, slope = 0, color = "red")+
  scale_y_continuous(labels = scales::label_percent())+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  coord_flip()+
  theme_minimal()+
  
  facet_wrap(~name,nrow = 4,scales = "fixed",shrink = F)+
  labs(
    x = "Week",
    y = "% change in deaths registered 2019/2020"
  )
  
 
  
```

```{r}

df_r %>%
  group_by(name, week_no, year_date) %>%
  summarise(total_deaths = sum(num_deaths)) %>%
  unite(col = "week_year", c(week_no, year_date), sep = "_") %>%
  group_by(week_year, name) %>%
  summarise(weekly_total = sum(total_deaths)) %>%
  separate(week_year, into = c("week", "year"), remove = T) %>%
  pivot_wider(names_from = year, values_from = weekly_total) %>%
  mutate(diff2020_2019 = (`2020` - `2019`) / `2019`) %>%
  filter(name == "Lubelskie") %>%
  ggplot(aes(week, diff2020_2019, group = 1, fill = if_else(diff2020_2019 > 0, "green", "red"))) +
  geom_col(show.legend = F) +
  geom_text(aes(label = paste0(round(diff2020_2019, 3) * 100, "%"))) +
  scale_y_continuous(labels = scales::label_percent()) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  #coord_flip() +
  theme_minimal()
 
```
```{r}
df_r %>%
  group_by(name, week_no, year_date) %>%
  summarise(total_deaths = sum(num_deaths)) %>%
  unite(col = "week_year", c(week_no, year_date), sep = "_") %>%
  group_by(week_year, name) %>%
  summarise(weekly_total = sum(total_deaths)) %>%
  separate(week_year, into = c("week", "year"), remove = T) %>%
  pivot_wider(names_from = year, values_from = weekly_total) %>%
  mutate(diff2020_2019 = (`2020` - `2019`) / `2019`) %>% 
  group_by(week) %>% 
  summarise(mean_poland=mean(diff2020_2019)) %>% 
  ggplot(aes(week, mean_poland, group = 1, fill = if_else(mean_poland > 0, "green", "red"))) +
  geom_col(show.legend = F) +
  geom_text(aes(label = paste0(round(mean_poland, 3) * 100, "%"), hjust = -.2)) +
  scale_y_continuous(labels = scales::label_percent()) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  coord_flip() +
  theme_minimal()
```

